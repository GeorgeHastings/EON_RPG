"use strict";var GameState={currentMoment:"",setCurrentMoment:function(e){this.currentMoment=e,UI.narrative.renderMoment(),this.checkForAndCreateChoices(),this.checkForAndPickUpLoot(),this.checkForAndRunCombat(),this.checkForAndOpenUpShop(),this.checkForAndRunInn(),UI.scrollToBottom(UI.narrative.el)},checkForFoundLoot:function(){return this.currentMoment.hasOwnProperty("dropLoot")&&!this.currentMoment.hasOwnProperty("enemy")},checkForAndPickUpLoot:function(){this.checkForFoundLoot()&&Player.pickUpLoot()},checkForAndRunCombat:function(){this.currentMoment.hasOwnProperty("enemy")&&Combat.runCombat()},checkForAndOpenUpShop:function(){this.currentMoment.hasOwnProperty("shop")?(UI.narrative.renderShop(),this.bindShopItemEvents()):this.bindWorldItemEvents()},checkForAndRunInn:function(){var e=this.currentMoment.hasOwnProperty("inn");if(e){var t=this.currentMoment.inn;Player.gold>=t?(Player.updateGold(-t),Player.healthTotal=Player.healthMax,Player.updateStats(),UI.combatLog.renderCombatLog(colorize("You",UI.colors.player)+" bought a room for "+colorize(t+" gold",UI.colors.gold)+"."),UI.combatLog.renderCombatLog(colorize("Your",UI.colors.player)+" health is "+colorize("fully restored","#24fb27"))):UI.combatLog.renderCombatLog(colorize("You",UI.colors.player)+" need "+colorize(t-Player.gold,UI.colors.gold)+" to get a room.")}},checkForAndCreateChoices:function(){var e=this.currentMoment.hasOwnProperty("choices");e&&UI.narrative.renderChoices()},bindWorldItemEvents:function(){for(var e=UI.inventory.el.querySelectorAll("[data-item]"),t=0;t<e.length;t++)e[t].onclick=UI.inventory.activateItem},bindShopItemEvents:function(){for(var e=UI.narrative.el.querySelectorAll("[data-item]"),t=UI.inventory.el.querySelectorAll("[data-item]"),o=0;o<e.length;o++)e[o].onclick=Player.purchaseItem;for(var r=0;r<t.length;r++)t[r].onclick=Player.sellItem}},Player={name:"You",level:1,healthMax:25,healthTotal:25,armor:0,strength:0,quickness:1,equippedWeapon:"",equippedArmor:{head:"",chest:"",back:"",belt:"",pants:"",boots:""},inventory:[],gold:0,experience:0,levelUp:function(){this.level=this.level+1,this.strength=this.strength+1,this.quickness=this.quickness+1,this.healthTotal=this.healthMax,this.updateStats(),UI.combatLog.renderCombatLog(colorize("You gained a level! Your strength and quickness have increased by 1.","yellow"))},calcNexLevelExp:function(){for(var e=80,t=0;t<Player.level;t++)e+=20*(t+1);return e},updateExperience:function(e){this.experience=this.experience+e,UI.combatLog.renderCombatLog(colorize("You","#fff")+" gained "+colorize(e+" experience.","#fff"))},updateStats:function(){this.setHealth(),this.setDamage(),this.setArmor(),this.setStrength(),this.setDamageReduction(),this.setQuicknessProc(),UI.statlist.renderStats()},updateGold:function(e){this.gold+=e,UI.inventory.renderGold()},setHealth:function(){this.health=""+this.healthTotal+"/"+this.healthMax},setArmor:function(){this.armor=0;for(var e in this.equippedArmor)this.equippedArmor[e].armorAmt&&(this.armor+=this.equippedArmor[e].armorAmt);this.armor+=this.strength},setDamage:function(){this.equippedWeapon?this.damage=""+this.equippedWeapon.damage[0]+"-"+this.equippedWeapon.damage[1]:this.damage="0-2"},setDamageReduction:function(){this.damageReduction=(1-.03*this.armor/(1+.03*this.armor)).toFixed(2)},setStrength:function(){this.healthMax=25+this.strength},setQuicknessProc:function(){this.quicknessProc=(.02*this.quickness/(1+.02*this.quickness)*100).toFixed(2)},getBaseDamage:function(){var e;e=this.equippedWeapon?roll(this.equippedWeapon.damage[0],this.equippedWeapon.damage[1]):roll(0,3),this.baseDamage=e},rollQuicknessProc:function(){var e=roll(0,100);return e<=this.quicknessProc?!0:!1},attack:function(e){this.getBaseDamage();var t=Math.round(this.baseDamage*e.damageReduction),o="hit",r="yellow";this.rollQuicknessProc()&&(t=2*t,o=""+colorize("critically hit",UI.colors.red),r=UI.colors.red),e.rollQuicknessProc()?UI.combatLog.renderCombatLog("("+colorize(e.healthTotal,colorHealth(e.healthTotal/e.healthMax))+") "+colorize(e.name,UI.colors.entity)+" "+colorize("dodged","yellow")+" "+colorize(this.name,UI.colors.entity)+" for 0"):(e.healthTotal-=t,UI.combatLog.renderCombatLog("("+colorize(this.healthTotal,colorHealth(this.healthTotal/this.healthMax))+") "+colorize(this.name,UI.colors.entity)+" "+o+" "+colorize(e.name,UI.colors.entity)+' for <span style="color: '+r+';">'+t+"</span>")),e!==Player&&Player.equippedWeapon.effect&&"ItemProc"===Player.equippedWeapon.effect.constructor.name&&Player.equippedWeapon.effect.run()&&(e.healthTotal-=Player.equippedWeapon.effect.amt,UI.combatLog.renderCombatLog("Your "+colorize(Player.equippedWeapon.name,UI.colors[Player.equippedWeapon.rarity])+" strikes "+colorize(e.name,UI.colors.entity)+' for <span style="color: '+r+';">'+Player.equippedWeapon.effect.amt+"</span>")),Player.updateStats()},pickUpGold:function(){var e=getObj(Enemies,GameState.currentMoment.enemy).level,t=roll(4,8)*e;Player.updateGold(t),UI.combatLog.renderCombatLog(""+colorize("You",UI.colors.player)+" found "+colorize(t+" gold.",UI.colors.gold))},pickUpLoot:function(){for(var e=0;e<GameState.currentMoment.dropLoot.length;e++){var t=GameState.currentMoment.dropLoot[e];this.addToInventory(t)}UI.combatLog.renderLootMessage()},addToInventory:function(e){var t=getObj(Items,e);this.inventory.push(t),UI.inventory.renderInventory()},removeFromInventory:function(e){var t=getObj(this.inventory,e),o=this.inventory.indexOf(t);o>-1&&this.inventory.splice(o,1)},equipWeapon:function(e){this.unequipCurrentWeapon(),this.equippedWeapon=e,this.updateStats()},equipArmor:function(e){this.equippedArmor[e.slot]=e,this.updateStats()},unequipArmor:function(e){if(this.equippedArmor[e.slot]="",e.effect)for(var t=0;t<e.effect.length;t++)e.effect[t].removeBuff()},unequipCurrentWeapon:function(){var e=this.equippedWeapon;if(e.effect)for(var t=0;t<e.effect.length;t++){var o="StatBuff"===e.effect[t].constructor.name;o===!0&&(console.log("up"),e.effect[t].removeBuff())}e&&(e="")},purchaseItem:function(){var e=this.getAttribute("data-item"),t=getObj(Items,e),o=Player.gold>=t.getPurchasePrice();o?(Player.updateGold(-t.getPurchasePrice()),Player.addToInventory(e),UI.inventory.renderInventory(),UI.combatLog.renderItemTransaction(colorize(t.name,UI.colors[t.rarity]),t.getPurchasePrice(),"bought")):UI.combatLog.renderCannotPurchaseMessage(colorize(t.name,UI.colors[t.rarity]),t.getPurchasePrice())},sellItem:function(){var e=this.getAttribute("data-item"),t=getObj(Items,e);Player.updateGold(t.getSalePrice()),t===Player.equippedWeapon&&Player.unequipCurrentWeapon(),t===Player.equippedArmor[t.slot]&&Player.unequipArmor(t),Player.removeFromInventory(e),Player.updateStats(),UI.itemDescription.hideItemDescription(),UI.inventory.renderInventory(),UI.combatLog.renderItemTransaction(colorize(t.name,UI.colors[t.rarity]),t.getSalePrice(),"sold")}},colorHealth=function(e){var t=[36,251,39],o=[255,104,57],r=t[0],n=t[1],i=t[2];return r+=(o[0]-t[0])*(1-e),n-=(t[1]-o[1])*(1-e),i+=(o[2]-t[2])*(1-e),"rgb("+r.toFixed(0)+", "+n.toFixed(0)+", "+i.toFixed(0)+")"},UI={items:document.querySelectorAll("[data-item]"),colors:{none:"#939DBD",common:"#fff",rare:"#4D75CE",epic:"#9E65C4",legendary:"#C6AF66",entity:"#fff",player:"#fff",enemy:"#fff",gold:"#E5CA48",red:"#ff6839"},narrative:{el:document.getElementById("narrative"),getMomentByClick:function(){var e=this.getAttribute("data-moment");GameState.setCurrentMoment(Moments["moment"+e])},renderShop:function(){for(var e=GameState.currentMoment.shop,t=UI.inventory.el.querySelectorAll("[data-item]"),o=0;o<e.length;o++){var r=getObj(Items,e[o]),n=document.createElement("a"),i=document.createTextNode(r.name);n.setAttribute("data-item",r.name),n.appendChild(i),UI.narrative.el.appendChild(n),n.onclick=Player.purchaseItem}for(var a=0;a<t.length;a++)t[a].onclick=Player.sellItem;UI.items=document.querySelectorAll("[data-item]"),UI.itemDescription.bindItemDescriptionEvents()},renderChoices:function(){for(var e=GameState.currentMoment.choices,t=0;t<e.length;t++){var o=e[t],r=document.createElement("a"),n=document.createTextNode(o.message);r.setAttribute("data-moment",o.link),r.appendChild(n),UI.narrative.el.appendChild(r),r.onclick=this.getMomentByClick}},renderMoment:function(){var e=document.createElement("p"),t=document.createTextNode(GameState.currentMoment.message);e.appendChild(t),UI.narrative.el.appendChild(e)}},statlist:{el:document.getElementById("stat-list"),renderStats:function(){for(var e=this.el.querySelectorAll("div"),t=0;t<e.length;t++){var o=e[t].parentNode.getAttribute("data-stat");e[t].innerHTML=Player[o]}}},inventory:{el:document.getElementById("inventory"),gold:document.getElementById("gold"),renderInventory:function(){this.el.innerHTML="";for(var e=0;e<Player.inventory.length;e++){var t=Player.inventory[e],o=document.createElement("li"),r=document.createTextNode(t.name),n=GameState.currentMoment.hasOwnProperty("shop"),i="armor"===t.itemType&&t===Player.equippedArmor[t.slot];o.appendChild(r),o.setAttribute("data-item",t.name),this.el.appendChild(o),n?GameState.bindShopItemEvents():GameState.bindWorldItemEvents(),t===Player.equippedWeapon&&this.renderEquippedWeapon(o),i&&o.classList.add("equipped-armor")}UI.items=document.querySelectorAll("[data-item]"),UI.itemDescription.bindItemDescriptionEvents()},renderGold:function(){UI.inventory.gold.innerHTML=Player.gold},removeEquippedWepTag:function(){var e=document.querySelector(".equipped-wep");e&&e.classList.remove("equipped-wep")},removeEquippedArmorTag:function(){for(var e=document.querySelectorAll(".equipped-armor"),t=0;t<e.length;t++)e[t].classList.remove("equipped-armor")},renderEquippedWeapon:function(e){this.removeEquippedWepTag(),e.classList.add("equipped-wep")},renderEquippedArmor:function(){this.removeEquippedArmorTag();for(var e in Player.equippedArmor)Player.equippedArmor[e].name&&UI.inventory.el.querySelector('[data-item="'+Player.equippedArmor[e].name+'"').classList.add("equipped-armor")},activateItem:function(){var e=this.getAttribute("data-item"),t=getObj(Items,e),o="weapon"===t.itemType&&Player.equippedWeapon!==t,r="armor"===t.itemType&&t!==Player.equippedArmor[t.slot];o&&(Player.equipWeapon(t),UI.inventory.renderEquippedWeapon(this),t.use()),r&&(Player.equipArmor(t),UI.inventory.renderEquippedArmor(),t.use()),"consumable"===t.itemType&&(Player.removeFromInventory(e),UI.itemDescription.hideItemDescription(),UI.inventory.renderInventory(),t.use()),"quest"===t.itemType&&t.use()}},itemDescription:{el:document.getElementById("itemDescription"),items:document.getElementById("descItems"),initialX:0,initialY:0,getInitialY:function(e){var t=e.pageY;return UI.itemDescription.intialY=t,t},getInitialX:function(e){var t=e.pageX;return UI.itemDescription.intialX=t,t},position:function(e){var t=UI.itemDescription,o=window.innerWidth,r=window.innerHeight,n=t.getInitialX(e),i=t.getInitialY(e),a="translate3d("+n+"px,"+i+"px, 0)";e.pageX+(t.el.offsetWidth+10)>o?t.el.style.left=t.initialX-t.el.offsetWidth-10+"px":t.el.style.left=t.initialX+10+"px",e.pageY+(t.el.offsetHeight+10)>r?t.el.style.top=t.initialY-t.el.offsetHeight-10+"px":UI.itemDescription.el.style.top=t.initialY+10+"px",t.el.style.webkitTransform=a,t.el.style.transform=a},showItemDescription:function(){UI.itemDescription.el.style.display="block"},hideItemDescription:function(){UI.itemDescription.el.style.display="none"},createEl:function(e,t){var o=document.createElement("div"),r=document.createTextNode(e);return o.classList.add(t),o.appendChild(r),o},renderItemDescription:function(){UI.itemDescription.items.innerHTML="";var e=this.getAttribute("data-item"),t=getObj(Items,e),o;for(var r in t)if("function"!=typeof t[r]){if(o="damage"===r?UI.itemDescription.createEl(t[r][0]+"-"+t[r][1],""+r):UI.itemDescription.createEl(t[r],""+r),"effect"===r){o=UI.itemDescription.createEl(t[r].description,""+r);for(var n=0;n<t.effect.length;n++)o=UI.itemDescription.createEl(t[r][n].description,""+r),UI.itemDescription.items.appendChild(o)}"rarity"===r&&(document.querySelector(".name").style.color=UI.colors[t[r]]),"flavorText"===r&&""===t[r]||UI.itemDescription.items.appendChild(o)}else if("getSalePrice"===r&&this.parentNode===UI.inventory.el){if(o=UI.itemDescription.createEl(t[r](),""+r),UI.itemDescription.items.appendChild(o),GameState.currentMoment.hasOwnProperty("shop")){var i=UI.itemDescription.createEl("(Click to sell)","shop-item");UI.itemDescription.items.appendChild(i)}}else if("getPurchasePrice"===r&&this.parentNode===UI.narrative.el&&(o=UI.itemDescription.createEl(t[r](),""+r),UI.itemDescription.items.appendChild(o),GameState.currentMoment.hasOwnProperty("shop"))){var a=UI.itemDescription.createEl("(Click to buy)","shop-item");UI.itemDescription.items.appendChild(a)}UI.itemDescription.showItemDescription()},getStatDescriptions:{level:function(){return"You have "+Player.experience+" points. You need "+(Player.calcNexLevelExp()-Player.experience)+" to reach the next level."},health:function(){return"You have "+(Player.healthTotal/Player.healthMax*100).toFixed(0)+"% health"},armor:function(){return"Reduces damage taken to "+(100*Player.damageReduction).toFixed(2)+"%"},quickness:function(){return""+Player.quicknessProc+"% chance to critical hit and dodge"},damage:function(){var e=(Player.equippedWeapon.damage[0]+Player.equippedWeapon.damage[1])/2,t=e+Player.quicknessProc/100*e;if(Player.equippedWeapon.effect&&"ItemProc"===Player.equippedWeapon.effect.constructor.name){var o=Player.equippedWeapon.effect.chance/100,r=Player.equippedWeapon.effect.amt;t+=o*r}return""+t.toFixed(2)+" average total damage per hit"},strength:function(){return"Increases armor and max health by "+Player.strength}},renderStatDescription:function(){var e=this.getAttribute("data-stat"),t=UI.itemDescription.getStatDescriptions[e](),o=UI.itemDescription.createEl(t,"stat");UI.itemDescription.items.innerHTML="",UI.itemDescription.items.appendChild(o),UI.itemDescription.showItemDescription()},bindItemDescriptionEvents:function(){for(var e=document.querySelectorAll("[data-item]"),t=document.querySelectorAll("[data-stat]"),o=0;o<e.length;o++)e[o].onmouseenter=this.renderItemDescription,e[o].onmousemove=this.position,e[o].onmouseleave=this.hideItemDescription;for(var r=0;r<t.length;r++)t[r].onmouseenter=this.renderStatDescription,t[r].onmousemove=this.position,t[r].onmouseleave=this.hideItemDescription}},combatLog:{el:document.getElementById("combatLog"),renderCombatLog:function(e){var t=document.createElement("p");t.innerHTML=e,this.el.appendChild(t),UI.scrollToBottom(UI.combatLog.el)},renderItemTransaction:function(e,t,o){this.renderCombatLog(colorize("You",UI.colors.player)+" "+o+" "+e+" for "+colorize(t+" gold",UI.colors.gold)+".")},renderCannotPurchaseMessage:function(e,t){this.renderCombatLog(colorize("You",UI.colors.player)+" need "+colorize(t-Player.gold+" gold",UI.colors.gold)+" to buy "+e+".")},renderLootMessage:function(){var e=GameState.currentMoment,t=e.dropLoot,o,r,n;if(o=e.enemy?" defeated "+colorize(e.enemy,"#fff"):"",t.length>0)if(r=" found",1===t.length){var i=getObj(Items,t[0]);r+=" "+colorize(t,UI.colors[i.rarity])}else for(var a=0;a<t.length;a++){var i=getObj(Items,t[a]);r+=a<t.length-1?" "+colorize(t[a],UI.colors[i.rarity])+",":" and "+colorize(t[a],UI.colors[i.rarity])}else r="";n=e.enemy&&t.length>0?" and":"",this.renderCombatLog(colorize("You",UI.colors.player)+o+n+r+".")}},scrollToBottom:function(e){e.scrollTop=e.scrollHeight}},Combat={fighting:!0,rounds:0,generateEnemy:function(){var e=getObj(Enemies,GameState.currentMoment.enemy),t=new Enemy(e.name,e.level,e.healthTotal,getObj(Items,e.equippedWeapon),e.armor,e.critChance);t.healthMax=t.healthTotal,Combat.enemy=t},playerWins:function(){Combat.fighting=!1,Player.pickUpLoot(),Player.pickUpGold(),Combat.awardExperience(),GameState.setCurrentMoment(Moments["moment"+GameState.currentMoment.link])},playerLoses:function(){Combat.fighting=!1,UI.combatLog.renderCombatLog(""+colorize("You",UI.colors.player)+" were slain by "+colorize(Combat.enemy.name,"#fff")),Player.updateStats(),GameState.setCurrentMoment(Moments.playerLost)},awardExperience:function(){var e=this.rounds+15*Combat.enemy.level;Player.updateExperience(e),Player.experience>Player.calcNexLevelExp()&&Player.levelUp()},fight:function(e){var t,o,r=Combat.enemy;e%2?(t=r,o=Player):(t=Player,o=r),t.healthTotal>0?t.attack(o):t===r?Combat.playerWins():Combat.playerLoses()},runCombat:function(){var e,t=0;Combat.generateEnemy(),UI.combatLog.renderCombatLog(colorize("You engage "+Combat.enemy.name,UI.colors.red)),e=setInterval(function(){Combat.fighting?(t++,Combat.fight(t)):(clearInterval(e),Combat.fighting=!0,Combat.rounds=t)},700)}},roll=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},getObj=function(e,t){var o=e.filter(function(e){return e.name===t});return o?o[0]:null},getFromArr=function(e,t){var o=e.filter(function(e){return e.slot===t});return o?o[0]:null},getObjLvl=function(e,t){for(var o=[],r=0;r<e.length;r++)e[r].level===t&&o.push(e[r]);return o},colorize=function(e,t){return'<span style="color: '+t+';">'+e+"</span>"},getRandomLootByLevel=function(e,t){var o=getObjLvl(e,t);return o[roll(0,o.length-1)].name};document.addEventListener("DOMContentLoaded",function(){Player.updateStats(),Player.updateGold(0)});